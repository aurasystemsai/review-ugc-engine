<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AURA • UGC ENGINE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        --bg: #020617;
        --panel: #020617;
        --panel-soft: #020617;
        --border: rgba(56, 189, 248, 0.4);
        --border-soft: rgba(56, 189, 248, 0.25);
        --ink: #e5f2ff;
        --muted: #9fb3d8;
        --accent: #00f0ff;
        --accent-strong: #00c4ff;
        --danger: #fb7185;
        --good: #4ade80;
        --radius-lg: 24px;
        --radius-md: 18px;
        --radius-pill: 999px;
        --shadow-soft: 0 26px 60px rgba(0, 0, 0, 0.85);
        --chip-bg: rgba(15, 23, 42, 0.9);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter",
          sans-serif;
        background: radial-gradient(circle at top, #020617 0, #020617 45%, #000 100%);
        color: var(--ink);
        -webkit-font-smoothing: antialiased;
      }

      .shell {
        max-width: 1100px;
        margin: 0 auto;
        padding: 32px 20px 40px;
      }

      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 24px;
        gap: 16px;
      }

      .title-block h1 {
        margin: 0 0 4px;
        font-size: 22px;
        letter-spacing: 0.16em;
        text-transform: uppercase;
        color: var(--accent);
      }

      .title-block p {
        margin: 0;
        font-size: 13px;
        color: var(--muted);
      }

      .status-chip {
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid var(--border-soft);
        font-size: 11px;
        color: var(--muted);
        background: linear-gradient(
          to right,
          rgba(15, 23, 42, 0.95),
          rgba(15, 23, 42, 0.75)
        );
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--good);
        box-shadow: 0 0 0 4px rgba(74, 222, 128, 0.3);
      }

      .console-card {
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-soft);
        background: radial-gradient(
          circle at top left,
          rgba(15, 23, 42, 0.95),
          rgba(2, 6, 23, 0.98)
        );
        box-shadow: var(--shadow-soft);
        padding: 18px 18px 20px;
      }

      .top-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 16px;
        margin-bottom: 16px;
      }

      .tabs {
        display: inline-flex;
        gap: 8px;
        border-radius: var(--radius-pill);
        padding: 4px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(30, 64, 175, 0.6);
      }

      .tab {
        border-radius: var(--radius-pill);
        padding: 5px 12px;
        font-size: 12px;
        border: none;
        background: transparent;
        color: var(--muted);
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .tab span.badge {
        font-size: 11px;
        min-width: 18px;
        text-align: center;
        padding: 1px 6px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.9);
      }

      .tab.active {
        background: radial-gradient(circle at top left, #00f0ff, #00c4ff);
        color: #020617;
      }

      .tab.active span.badge {
        background: rgba(2, 6, 23, 0.85);
        color: #e5f2ff;
      }

      .site-row {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .site-row label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--muted);
      }

      #siteIdInput {
        min-width: 260px;
        padding: 7px 10px;
        border-radius: 999px;
        border: 1px solid rgba(15, 23, 42, 1);
        background: rgba(15, 23, 42, 0.95);
        color: var(--ink);
        font-size: 13px;
        outline: none;
      }

      #siteIdInput:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 1px rgba(34, 211, 238, 0.4);
      }

      #refreshBtn {
        border-radius: 999px;
        padding: 7px 14px;
        border: 1px solid var(--border);
        background: radial-gradient(circle at 0% 0%, #00f0ff, #00c4ff);
        color: #020617;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
      }

      #refreshBtn:hover {
        box-shadow: 0 12px 30px rgba(8, 47, 73, 0.8);
      }

      .subline {
        font-size: 11px;
        color: var(--muted);
        margin-bottom: 8px;
      }

      .list {
        border-radius: 18px;
        border: 1px dashed rgba(51, 65, 85, 0.9);
        background: radial-gradient(
          circle at top left,
          rgba(15, 23, 42, 0.85),
          rgba(15, 23, 42, 0.95)
        );
        padding: 10px 10px 4px;
        min-height: 120px;
      }

      .empty {
        font-size: 12px;
        color: var(--muted);
        text-align: center;
        padding: 20px 8px;
      }

      .review {
        border-radius: 14px;
        border: 1px solid rgba(30, 64, 175, 0.6);
        background: rgba(15, 23, 42, 0.95);
        padding: 10px 10px 8px;
        margin-bottom: 8px;
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 12px;
      }

      .review-header {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 2px;
      }

      .review-main {
        white-space: normal;
      }

      .pill-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 2px;
      }

      .pill {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 999px;
        border: 1px solid rgba(30, 64, 175, 0.7);
        background: rgba(15, 23, 42, 0.9);
        color: var(--muted);
      }

      .pill.good {
        border-color: rgba(22, 163, 74, 0.7);
        color: #bbf7d0;
      }

      .pill.danger {
        border-color: rgba(239, 68, 68, 0.8);
        color: #fecaca;
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 4px;
      }

      .btn-approve,
      .btn-reject {
        font-size: 11px;
        border-radius: 999px;
        padding: 4px 8px;
        border: 1px solid transparent;
        background: transparent;
        cursor: pointer;
      }

      .btn-approve {
        border-color: rgba(22, 163, 74, 0.8);
        color: #bbf7d0;
        background: rgba(22, 163, 74, 0.1);
      }

      .btn-reject {
        border-color: rgba(248, 113, 113, 0.9);
        color: #fecaca;
        background: rgba(127, 29, 29, 0.1);
      }

      .ai-meta {
        font-size: 11px;
        color: var(--muted);
      }

      .rating {
        color: #facc15;
        font-size: 13px;
      }

      .toast {
        position: fixed;
        right: 20px;
        top: 20px;
        padding: 8px 12px;
        border-radius: 999px;
        font-size: 12px;
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid var(--border);
        color: var(--ink);
        box-shadow: var(--shadow-soft);
        z-index: 999999;
      }

      @media (max-width: 720px) {
        .shell {
          padding: 20px 14px 30px;
        }
        .header {
          flex-direction: column;
          align-items: flex-start;
        }
        .top-row {
          flex-direction: column;
          align-items: flex-start;
        }
        .site-row {
          width: 100%;
        }
        #siteIdInput {
          flex: 1;
          min-width: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <div class="header">
        <div class="title-block">
          <h1>AURA • UGC ENGINE</h1>
          <p>Moderator console · AI-scored reviews from all widgets.</p>
        </div>
        <div class="status-chip">
          <span class="status-dot"></span>
          <span id="statusLabel">Connected to Render API</span>
        </div>
      </div>

      <div class="console-card">
        <div class="top-row">
          <div class="tabs" id="tabs">
            <button class="tab active" data-status="pending" id="tabPending">
              Pending <span class="badge" id="badgePending">0</span>
            </button>
            <button class="tab" data-status="approved" id="tabApproved">
              Approved <span class="badge" id="badgeApproved">0</span>
            </button>
            <button class="tab" data-status="rejected" id="tabRejected">
              Rejected <span class="badge" id="badgeRejected">0</span>
            </button>
          </div>

          <div class="site-row">
            <label for="siteIdInput">Site ID</label>
            <input
              id="siteIdInput"
              type="text"
              placeholder="e.g. domain:clientsite.com"
              value=""
            />
            <button id="refreshBtn">Refresh</button>
          </div>
        </div>

        <div class="subline" id="subline">Showing: PENDING</div>

        <div class="list" id="list"></div>
      </div>
    </div>

    <script>
      (function () {
        const API_BASE = "https://review-ugc-engine.onrender.com";

        const tabsEl = document.getElementById("tabs");
        const listEl = document.getElementById("list");
        const siteIdInput = document.getElementById("siteIdInput");
        const sublineEl = document.getElementById("subline");
        const badgePending = document.getElementById("badgePending");
        const badgeApproved = document.getElementById("badgeApproved");
        const badgeRejected = document.getElementById("badgeRejected");
        const refreshBtn = document.getElementById("refreshBtn");

        let currentStatus = "pending";

        // ---- Site ID init from query (hardcoded snippet passes ?site_id=...) ----
        (function initSiteIdFromQuery() {
          try {
            const params = new URLSearchParams(window.location.search);
            const qs = params.get("site_id");
            if (qs) {
              siteIdInput.value = decodeURIComponent(qs);
            }
          } catch (e) {
            console.warn("[AURA] Failed to read site_id from query:", e);
          }
        })();

        function toast(message) {
          const existing = document.getElementById("auraToast");
          if (existing) existing.remove();

          const t = document.createElement("div");
          t.id = "auraToast";
          t.className = "toast";
          t.textContent = message;
          document.body.appendChild(t);
          setTimeout(() => t.remove(), 2800);
        }

        function getSiteId() {
          const v = siteIdInput.value.trim();
          if (!v) {
            toast("Enter a site ID (e.g. domain:clientsite.com)");
          }
          return v;
        }

        function setSubline(status) {
          let label = "PENDING";
          if (status === "approved") label = "APPROVED";
          if (status === "rejected") label = "REJECTED";
          sublineEl.textContent = "Showing: " + label;
        }

        function setActiveTab(status) {
          const tabs = tabsEl.querySelectorAll(".tab");
          tabs.forEach((t) => {
            if (t.dataset.status === status) {
              t.classList.add("active");
            } else {
              t.classList.remove("active");
            }
          });
        }

        function fetchReviews(status) {
          const siteId = getSiteId();
          if (!siteId) {
            listEl.innerHTML =
              '<div class="empty">No site selected yet.</div>';
            return;
          }

          listEl.innerHTML =
            '<div class="empty">Loading ' + status + " reviews…</div>";

          const url =
            API_BASE +
            "/api/ugc/moderation/" +
            encodeURIComponent(status) +
            "?site_id=" +
            encodeURIComponent(siteId);

          fetch(url, { credentials: "omit" })
            .then((res) => {
              if (!res.ok) throw new Error("HTTP " + res.status);
              return res.json();
            })
            .then((data) => {
              const arr = Array.isArray(data) ? data : [];
              renderList(status, arr);
              updateBadge(status, arr.length);
            })
            .catch((err) => {
              console.error("[AURA] Failed to load reviews:", err);
              listEl.innerHTML =
                '<div class="empty">Unable to load reviews. Check console for details.</div>';
            });
        }

        function updateBadge(status, count) {
          const n = count || 0;
          if (status === "pending") badgePending.textContent = n;
          if (status === "approved") badgeApproved.textContent = n;
          if (status === "rejected") badgeRejected.textContent = n;
        }

        function renderList(status, reviews) {
          if (!reviews.length) {
            listEl.innerHTML =
              '<div class="empty">No reviews in this status yet for this site.</div>';
            return;
          }

          listEl.innerHTML = "";

          reviews.forEach((r) => {
            const el = document.createElement("div");
            el.className = "review";

            const rating =
              typeof r.rating === "number" && r.rating > 0 ? r.rating : null;
            const stars = rating
              ? "★".repeat(rating) + "☆".repeat(Math.max(0, 5 - rating))
              : "";

            const created = r.created_at || "";
            const channel = r.channel || "";
            const type = r.type || "";
            const label = r.ai_label || "";

            el.innerHTML =
              '<div class="review-header">' +
              '<div><strong>' +
              (r.customer_id || "Customer") +
              "</strong></div>" +
              '<div class="rating">' +
              stars +
              "</div>" +
              "</div>" +
              '<div class="review-main">' +
              (r.text || "") +
              "</div>" +
              '<div class="pill-row">' +
              (channel
                ? '<span class="pill">Channel: ' + channel + "</span>"
                : "") +
              (type ? '<span class="pill">Type: ' + type + "</span>" : "") +
              (created
                ? '<span class="pill">Created: ' + created + "</span>"
                : "") +
              (label
                ? '<span class="pill good">AI: ' + label + "</span>"
                : "") +
              "</div>" +
              '<div class="ai-meta">' +
              (r.ai_reasons || "") +
              "</div>";

            if (status === "pending") {
              const actions = document.createElement("div");
              actions.className = "actions";

              const approveBtn = document.createElement("button");
              approveBtn.className = "btn-approve";
              approveBtn.textContent = "Approve";
              approveBtn.addEventListener("click", () =>
                moderate(r.id, "approve")
              );

              const rejectBtn = document.createElement("button");
              rejectBtn.className = "btn-reject";
              rejectBtn.textContent = "Reject";
              rejectBtn.addEventListener("click", () =>
                moderate(r.id, "reject")
              );

              actions.appendChild(approveBtn);
              actions.appendChild(rejectBtn);
              el.appendChild(actions);
            }

            listEl.appendChild(el);
          });
        }

        function moderate(id, action) {
          const siteId = getSiteId();
          if (!siteId) return;
          if (!id) return;

          const endpoint =
            API_BASE +
            "/api/ugc/moderation/" +
            encodeURIComponent(id) +
            "/" +
            encodeURIComponent(action);

          const payload = {
            moderator_id: "admin",
            moderator_notes: action === "approve" ? "Approved" : "Rejected",
          };

          fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          })
            .then((res) => {
              if (!res.ok) throw new Error("HTTP " + res.status);
              return res.json();
            })
            .then(() => {
              toast(
                action === "approve"
                  ? "Review approved."
                  : "Review rejected."
              );
              fetchReviews(currentStatus);
            })
            .catch((err) => {
              console.error("[AURA] Moderation failed:", err);
              toast("Moderation failed – see console.");
            });
        }

        // ---- events ----
        tabsEl.addEventListener("click", function (e) {
          const btn = e.target.closest(".tab");
          if (!btn) return;
          const status = btn.dataset.status;
          if (!status) return;
          currentStatus = status;
          setActiveTab(status);
          setSubline(status);
          fetchReviews(status);
        });

        refreshBtn.addEventListener("click", function () {
          fetchReviews(currentStatus);
        });

        // initial load (pending)
        setSubline("pending");
        fetchReviews("pending");
      })();
    </script>
  </body>
</html>
