<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AURA • UGC Moderation Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #05080f;
      --panel: #070c15;
      --panel-soft: #0b111c;
      --border: rgba(0, 240, 255, 0.32);
      --border-soft: rgba(0, 240, 255, 0.12);
      --ink: #e7f6ff;
      --muted: #9fb3d8;
      --accent: #00f0ff;
      --danger: #ff4f6b;
      --good: #5fffd3;
      --radius-lg: 18px;
      --radius-pill: 999px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
      background: radial-gradient(circle at top, #051428 0, #030712 52%, #000 100%);
      color: var(--ink);
      min-height: 100vh;
      padding: 24px;
    }

    .shell {
      max-width: 1120px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      gap: 16px;
    }

    .logo {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .logo-title {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--accent);
    }

    .logo-sub {
      font-size: 13px;
      color: var(--muted);
    }

    .pill {
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-soft);
      padding: 6px 12px;
      font-size: 12px;
      color: var(--muted);
      background: linear-gradient(90deg, rgba(0, 240, 255, 0.12), transparent);
    }

    .card {
      background: linear-gradient(145deg, rgba(11, 17, 28, 0.96), rgba(4, 8, 16, 0.98));
      border-radius: 24px;
      border: 1px solid var(--border-soft);
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.75);
      padding: 20px;
    }

    .tabs {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }

    .tab {
      border-radius: var(--radius-pill);
      border: 1px solid transparent;
      padding: 8px 14px;
      font-size: 13px;
      color: var(--muted);
      background: rgba(8, 13, 24, 0.9);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.16s ease-out;
    }

    .tab span.count {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: var(--radius-pill);
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
    }

    .tab.active {
      border-color: var(--border);
      background: radial-gradient(circle at top left, rgba(0, 240, 255, 0.16), rgba(8, 13, 24, 0.98));
      color: var(--ink);
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .toolbar-left {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .input {
      background: rgba(9, 13, 23, 0.96);
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-soft);
      padding: 7px 12px;
      color: var(--ink);
      font-size: 13px;
      min-width: 220px;
      outline: none;
    }

    .input::placeholder {
      color: var(--muted);
    }

    .btn {
      border-radius: var(--radius-pill);
      border: 1px solid var(--border-soft);
      padding: 7px 14px;
      font-size: 13px;
      background: rgba(8, 13, 24, 0.96);
      color: var(--ink);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.16s ease-out;
    }

    .btn.primary {
      border-color: var(--border);
      background: linear-gradient(90deg, rgba(0, 240, 255, 0.26), rgba(0, 240, 255, 0.06));
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.55);
    }

    .reviews-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 10px;
    }

    @media (min-width: 920px) {
      .reviews-grid {
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      }
    }

    .review-card {
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.96), rgba(10, 15, 28, 0.98));
      border-radius: var(--radius-lg);
      border: 1px solid rgba(15, 23, 42, 1);
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
    }

    .pill-sm {
      border-radius: var(--radius-pill);
      border: 1px solid rgba(51, 65, 85, 0.9);
      padding: 2px 8px;
      font-size: 11px;
      color: var(--muted);
    }

    .pill-sm.status-pending {
      border-color: var(--accent);
      color: var(--accent);
    }

    .pill-sm.status-approved {
      border-color: var(--good);
      color: var(--good);
    }

    .pill-sm.status-rejected {
      border-color: var(--danger);
      color: var(--danger);
    }

    .rating {
      font-size: 13px;
      color: var(--good);
    }

    .review-text {
      font-size: 13px;
      color: var(--ink);
    }

    .meta-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 11px;
      color: var(--muted);
    }

    .ai-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 11px;
      color: var(--muted);
      border-top: 1px dashed rgba(30, 64, 175, 0.5);
      padding-top: 6px;
      margin-top: 6px;
    }

    .actions-row {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 6px;
    }

    .btn-approve {
      border-color: rgba(34, 197, 94, 0.5);
      color: var(--good);
    }

    .btn-reject {
      border-color: rgba(248, 113, 113, 0.6);
      color: var(--danger);
    }

    .empty-state {
      padding: 20px;
      text-align: center;
      font-size: 13px;
      color: var(--muted);
      border-radius: 16px;
      border: 1px dashed var(--border-soft);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.96), rgba(6, 9, 18, 0.98));
      margin-top: 10px;
    }

    .status-chip {
      font-weight: 500;
    }

    .status-chip.pending { color: var(--accent); }
    .status-chip.approved { color: var(--good); }
    .status-chip.rejected { color: var(--danger); }

    .small-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .loading {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .error {
      font-size: 13px;
      color: var(--danger);
      margin-bottom: 6px;
    }
  </style>
</head>
<body>
  <div class="shell">
    <header class="header">
      <div class="logo">
        <div class="logo-title">AURA • UGC Engine</div>
        <div class="logo-sub">Moderator console · AI-scored reviews from all widgets.</div>
      </div>
      <div class="pill">Connected to Render API</div>
    </header>

    <main class="card">
      <div class="tabs">
        <button class="tab pending active" data-status="pending">
          Pending
          <span class="count" id="count-pending">0</span>
        </button>
        <button class="tab approved" data-status="approved">
          Approved
          <span class="count" id="count-approved">0</span>
        </button>
        <button class="tab rejected" data-status="rejected">
          Rejected
          <span class="count" id="count-rejected">0</span>
        </button>
      </div>

      <div class="toolbar">
        <div class="toolbar-left">
          <input
            id="siteIdInput"
            class="input"
            type="text"
            placeholder="Site ID (e.g. demo-site)"
            value="demo-site"
          />
          <button id="refreshBtn" class="btn primary">Refresh</button>
        </div>
      </div>

      <div id="stateMessage" class="loading">Loading reviews from Render…</div>

      <div class="small-label" id="statusLabel">Showing: Pending</div>

      <div id="reviewsGrid" class="reviews-grid"></div>

      <div id="emptyState" class="empty-state" style="display: none;">
        No reviews in this status yet for this site.
      </div>
    </main>
  </div>

  <script>
    const API_BASE = "https://review-ugc-engine.onrender.com"; // Render URL

    const tabs = document.querySelectorAll(".tab");
    const reviewsGrid = document.getElementById("reviewsGrid");
    const stateMessage = document.getElementById("stateMessage");
    const emptyState = document.getElementById("emptyState");
    const siteIdInput = document.getElementById("siteIdInput");
    const refreshBtn = document.getElementById("refreshBtn");
    const statusLabel = document.getElementById("statusLabel");

    const counts = {
      pending: document.getElementById("count-pending"),
      approved: document.getElementById("count-approved"),
      rejected: document.getElementById("count-rejected")
    };

    let currentStatus = "pending";

    function setLoading(isLoading, errorMessage) {
      if (isLoading) {
        stateMessage.className = "loading";
        stateMessage.textContent = "Loading reviews from Render…";
        stateMessage.style.display = "block";
      } else if (errorMessage) {
        stateMessage.className = "error";
        stateMessage.textContent = errorMessage;
        stateMessage.style.display = "block";
      } else {
        stateMessage.style.display = "none";
      }
    }

    function formatDate(ts) {
      if (!ts) return "-";
      try {
        const d = new Date(ts);
        return d.toLocaleString();
      } catch {
        return ts;
      }
    }

    function escapeHtml(str) {
      return String(str || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function renderReviews(list) {
      reviewsGrid.innerHTML = "";

      counts.pending.textContent = list.filter((r) => (r.status || "pending") === "pending").length;
      counts.approved.textContent = list.filter((r) => (r.status || "").toLowerCase() === "approved").length;
      counts.rejected.textContent = list.filter((r) => (r.status || "").toLowerCase() === "rejected").length;

      const filtered = list.filter((r) => {
        const s = (r.status || "pending").toLowerCase();
        return s === currentStatus;
      });

      if (filtered.length === 0) {
        emptyState.style.display = "block";
        return;
      }

      emptyState.style.display = "none";

      for (const r of filtered) {
        const card = document.createElement("div");
        card.className = "review-card";

        const status = (r.status || "pending").toLowerCase();

        card.innerHTML = `
          <div class="review-header">
            <div>
              <div class="pill-sm status-${status}">
                <span class="status-chip ${status}">
                  ${
                    status === "pending"
                      ? "Pending review"
                      : status === "approved"
                      ? "Approved"
                      : "Rejected"
                  }
                </span>
              </div>
              <div class="meta-row" style="margin-top:4px;">
                <span>Site: <strong>${r.site_id || "-"}</strong></span>
                <span>Product: <strong>${r.product_id || "-"}</strong></span>
                ${
                  r.order_id
                    ? `<span>Order: <strong>${r.order_id}</strong></span>`
                    : ""
                }
              </div>
            </div>
            <div class="rating">
              ${r.rating ? "★".repeat(r.rating) : ""}
            </div>
          </div>

          <div class="review-text" style="margin-top:4px;">
            ${escapeHtml(r.text || "")}
          </div>

          <div class="meta-row">
            <span>Customer: <strong>${r.customer_id || "-"}</strong></span>
            <span>Channel: ${r.channel || "web"}</span>
            <span>Created: ${formatDate(r.created_at)}</span>
            <span>Updated: ${formatDate(r.updated_at)}</span>
          </div>

          <div class="ai-row">
            <span>AI Score: <strong>${typeof r.ai_score === "number" ? r.ai_score.toFixed(2) : "-"}</strong></span>
            <span>Label: <strong>${r.ai_label || "-"}</strong></span>
            <span style="flex:1;min-width:100%;">
              ${escapeHtml(r.ai_reasons || "")}
            </span>
          </div>

          ${
            r.moderator_id || r.moderator_notes
              ? `<div class="meta-row">
                  <span>Moderator: <strong>${r.moderator_id || "-"}</strong></span>
                  <span>Notes: ${escapeHtml(r.moderator_notes || "")}</span>
                </div>`
              : ""
          }
        `;

        if (status === "pending") {
          const actions = document.createElement("div");
          actions.className = "actions-row";

          const approveBtn = document.createElement("button");
          approveBtn.className = "btn btn-approve";
          approveBtn.textContent = "Approve";
          approveBtn.onclick = () =>
            updateStatus(r.id, "approve", "Moderator", "Approved via console");

          const rejectBtn = document.createElement("button");
          rejectBtn.className = "btn btn-reject";
          rejectBtn.textContent = "Reject";
          rejectBtn.onclick = () =>
            updateStatus(r.id, "reject", "Moderator", "Rejected via console");

          actions.appendChild(approveBtn);
          actions.appendChild(rejectBtn);
          card.appendChild(actions);
        }

        reviewsGrid.appendChild(card);
      }
    }

    async function fetchAll() {
      const siteId = siteIdInput.value.trim() || "demo-site";
      setLoading(true);

      try {
        const url = `${API_BASE}/api/ugc/moderation/all?site_id=${encodeURIComponent(
          siteId
        )}&status=all`;

        const res = await fetch(url);
        if (!res.ok) {
          throw new Error(`API error ${res.status}`);
        }

        const data = await res.json();
        setLoading(false);
        renderReviews(Array.isArray(data) ? data : []);
      } catch (err) {
        console.error(err);
        setLoading(false, "Failed to load reviews from Render.");
        reviewsGrid.innerHTML = "";
        emptyState.style.display = "block";
      }
    }

    async function updateStatus(id, action, moderatorId, notes) {
      try {
        setLoading(true);
        const url = `${API_BASE}/api/ugc/moderation/${id}/${action}`;
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            moderator_id: moderatorId,
            moderator_notes: notes
          })
        });

        if (!res.ok) {
          throw new Error(`API error ${res.status}`);
        }

        await fetchAll();
      } catch (err) {
        console.error(err);
        setLoading(false, "Failed to update review status.");
      }
    }

    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        tabs.forEach((t) => t.classList.remove("active"));
        tab.classList.add("active");
        currentStatus = tab.dataset.status || "pending";
        statusLabel.textContent =
          "Showing: " +
          currentStatus.charAt(0).toUpperCase() +
          currentStatus.slice(1);
        fetchAll();
      });
    });

    refreshBtn.addEventListener("click", () => fetchAll());

    // Initial load
    fetchAll();
  </script>
</body>
</html>
